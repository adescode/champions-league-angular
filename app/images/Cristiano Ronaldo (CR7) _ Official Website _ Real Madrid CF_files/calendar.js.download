RM.ns("matches",function(e){e.Calendar=function(e,t){_.bindAll(this,"on_change","on_ajax_success","on_ajax_fail","on_option_change"),this.options=$.extend({},this.defaults,t),this.on_change=_.debounce(this.on_change,this.options.delay),this.element=e,this.replacable_current=this.element.find("[data-replacable=current]"),this.replacable_past=this.element.find("[data-replacable=past]"),this.serialized_data=null,this.init()},$.extend(e.Calendar.prototype,{defaults:{delay:500},init:function(){this.element.on("change","select",this.on_option_change).on("change",this.on_change).on("click","label",this.on_change)},on_label_click:function(){},on_option_change:function(e){var t=$(e.target),a=t.is("label")?this.element.find(t.attr("for")):t;this.options.before_send&&this.options.before_send.call(this,a)},on_change:function(e){var t=$(e.target),a=(t.is("label")?this.element.find(t.attr("for")):t,!!t.closest(".m_matches_calendar").length);if(a||t.is("select")){a&&(t.closest("ul").find(".active").removeClass("active"),t.closest("li").addClass("active"));var s=this.element.serialize();this.serialized_data!=s&&(this.serialized_data=s,this.load())}},load:function(){this.element.addClass("loading");var e=$.ajax({url:this.element.attr("action"),dataType:"json",data:this.serialized_data,method:this.element.attr("method")||"get"});e.done(this.on_ajax_success).fail(this.on_ajax_fail)},on_ajax_success:function(e){_.templateSettings={evaluate:/\{\{([\s\S]+?)\}\}/g,interpolate:/\{\{=([\s\S]+?)\}\}/g,escape:/\{\{-([\s\S]+?)\}\}/g},e.matches||(e.matches=[]);var t=_($(".m_matches_calendar_template",this.element).html()).chain().trim().template().value(),a=new Date;if(groups=_(e.matches).chain().map(function(e){return{html:_.trim(t(e)),date:e.details.timestamp}}).groupBy(function(e){var t=new Date(parseInt(e.date,10));return a>=t?"past":"current"}).value(),groups.past||groups.current)if(groups.past&&groups.current)RM.utils.log("groups.past && groups.current"),this.replacable_current.html(_(groups.current).map(function(e){return e.html}).join("")),this.replacable_past.html(_(groups.past).map(function(e){return e.html}).join("")),this.element.find(".m_matches_title").show(),this.replacable_past.show().parent().show();else{RM.utils.log("no !groups.past && !groups.current ni groups.past && groups.current"),this.element.find(".m_matches_title").hide(),this.replacable_past.empty().parent().hide();var s=groups.current?groups.current:groups.past;this.replacable_current.html(_(s).map(function(e){return e.html}).join(""))}else RM.utils.log("!groups.past && !groups.current"),this.replacable_past.empty().parent().hide(),this.element.find(".m_matches_title").hide(),this.replacable_current.html(t({empty:!0}));RM.fn.init_inline_popups(this.element.find(".inline_popup")),this.element.removeClass("loading")},on_ajax_fail:function(){this.element.removeClass("loading")}})}),RM.ready(function(){$(".m_matches_calendar_form").each(function(){var e,t=$(this),a=t.find(".m_matches_with_tickets");a.length&&(e={before_send:function(e,t){if(!t){var a=e.closest(".m_matches_with_tickets"),s=e.val();s?a.removeClass("m_matches_with_tickets_all"):a.addClass("m_matches_with_tickets_all")}}}),new RM.matches.Calendar($(this),e)})});